---
title: "Generalized Linear Models in 3D"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generalized Linear Models in 3D}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = F,
  warning = F
)
```

## Introduction

A multiple *linear* regression creates a flat regression surface. A multiple linear regression with an *interaction* term can be depicted as a curved regression surface with linear marginal effects. A *generalized linear model (glm)* takes a linear component as a variable in a nonlinear function, creating a curved regression surface with nonlinear marginal effects. 

This vignette demonstrates a binomial model and a Gamma model. At this time, __regress3d__ has been tested on binomial models, negative binomials, and Gammas, but it should work for all generalized linear models. The function `add_jitter()` is demonstrated in the example of a binomial glm. Note that interaction terms are also allowed in the graphics for generalized linear regressions.

# Setup

The package regress3d is built on the syntax of plotly in R. Both libraries are called in the initial setup.

```{r setup}
library(regress3d)
library(plotly)
```


# Logistic Regression

## Data

The variables in the regression are county level measures from 2016. For pedagogical purposes, the variables are chosen to emphasize the s-shape of a logistic regression.

* `plurality_Trump16`: a binary variable indicating whether the plurality of a county voted for Trump in 2016.
* `any_college`: the percent of adults in the county that had ever enrolled in college, regardless of whether they graduated.
* `prcnt_black`: the percent of the county that identified as Black in the 2016 census. 

For the purpose of this example the regression is not weighted by `pop_estimate16`. When using weights, the regression only produces 0 and 1 estimates. 

## 2D plot of a logistic regression

For reference, a two dimensional plot of logistic regression can look like this. The outcome variable, `plurality_Trump16`, is binary. The explanatory variable, `prcnt_black`, is continuous. The model is specified to require an s-shape for the predicted probabilities cannot exceed the range $(0,1)$.

```{r}
county_data %>%
  ggplot(aes(x = prcnt_black, y = plurality_Trump16)) +
  geom_point() + 
  geom_smooth(method = "glm", method.args = list(family = "binomial")) 
```

## 3D plot of a logistic regression

The three dimensional plot adds education to the logistic regression. 

```{r, out.width = "800px", out.height = "450px"}
# county_data$frac_gop16 <- county_data$prcnt_GOP16/100 

mymodel <- glm(plurality_Trump16 ~ any_college+prcnt_black, 
               data = county_data, 
               family = "binomial")

plot_ly( data = county_data,
                        x = ~any_college,
                        y = ~prcnt_black,
                        z = ~plurality_Trump16) %>%
  add_markers(size = 1, color = I('black'))%>%
  add_3d_surface(model = mymodel, ci = T) %>%
  add_marginals(model = mymodel, ci = T) 

```

## Numeric regression results


```{r, results='asis', echo =F}
library(stargazer)

one_var_model <- glm(plurality_Trump16 ~ prcnt_black, 
               data = county_data, 
               family = "binomial")

two_vars_model <- glm(plurality_Trump16 ~ any_college+prcnt_black, 
               data = county_data, 
               family = "binomial")

stargazer(one_var_model, two_vars_model , type = 'html',
          keep.stat = c("n", "adj.rsq"),
          star.cutoffs = c(0.05),
          covariate.labels = c("County college experience","% Black", "Constant"),
          dep.var.labels = "plurality of county voted for Trump in 2016",
          dep.var.caption = "",
          model.numbers          = FALSE, 
          notes="<span>&#42;</span> p<0.05",
          notes.append=F)
```



# Gamma Model

```{r}
county_data %>%
  ggplot(aes(x = median_income16)) +
  geom_histogram()
```

```{r, out.width = "800px", out.height = "450px"}
mymodel <- glm(median_income16 ~ prcnt_black +any_college, 
               data = county_data, weight = pop_estimate16, family = Gamma)

p <- plot_ly( data = county_data,
              x = ~prcnt_black,
              y = ~any_college,
              z = ~median_income16) %>%
  add_markers(size = ~pop_estimate16, color = I('black')) %>%
  add_3d_surface(model = mymodel)%>%
  add_marginals(model = mymodel) 

p
```


```{r, out.width = "800px", out.height = "450px", eval = F, echo = F}
# mymodel <- glm(median_income16 ~ prcnt_black *any_college, data = county_data, family = Gamma)
# p <- plot_ly( data = county_data,
#               x = ~prcnt_black,
#               y = ~any_college,
#               z = ~median_income16) %>%
#   add_markers(size = ~pop_estimate16, color = I('black')) %>%
#   add_3d_surface(model = mymodel)%>%
#   add_marginals(model = mymodel) %>%
#   layout(
#     scene = list(
#       zaxis = list(range = c(0, 140000))))
```
